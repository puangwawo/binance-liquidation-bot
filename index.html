
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>XRP TF-5m + AI Signals</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,#0ea5e9 0%,#6366f1 100%);min-height:100vh;color:#111}
    .container{max-width:1200px;margin:0 auto;padding:18px}
    .header{color:#fff;text-align:center;margin-bottom:16px}
    .header h1{font-size:2rem;margin-bottom:6px;text-shadow:2px 2px 4px rgba(0,0,0,.25)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px}
    .card{background:#fff;border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.08);padding:16px}
    .card h2{font-size:1.1rem;margin-bottom:10px;border-bottom:3px solid #0ea5e9;display:inline-block;padding-bottom:4px}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:10px}
    .stat{background:#f8fafc;border-radius:12px;padding:10px;text-align:center}
    .stat .v{font-weight:700;color:#0ea5e9;font-size:1.3rem}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .btn{background:linear-gradient(135deg,#0ea5e9 0%,#6366f1 100%);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.secondary{background:linear-gradient(135deg,#22c55e 0%,#16a34a 100%)}
    .btn.warn{background:linear-gradient(135deg,#f97316 0%,#ea580c 100%)}
    .input,.select{padding:10px;border:1px solid #e5e7eb;border-radius:10px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:600;font-size:.85rem}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;font-size:.95rem}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;color:#111827;background:#f3f4f6;border-radius:8px;padding:8px}
    .ok{color:#16a34a}.warnc{color:#ea580c}.bad{color:#dc2626}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸš€ XRP TFâ€‘5m + AI Recommendations</h1>
      <div>Live price â€¢ 5â€‘minute klines â€¢ AI summary (optional)</div>
    </div>

    <div class="row">
      <div class="card">
        <h2>Price & Quick Stats</h2>
        <div class="stats">
          <div class="stat">
            <div class="v" id="price">$0.00</div>
            <div>Price (USDT)</div>
          </div>
          <div class="stat">
            <div class="v" id="trend">â€”</div>
            <div>TFâ€‘5m Trend</div>
          </div>
          <div class="stat">
            <div class="v" id="rsi">â€”</div>
            <div>RSI(14)</div>
          </div>
          <div class="stat">
            <div class="v" id="maSig">â€”</div>
            <div>MA Cross</div>
          </div>
        </div>
        <div class="controls">
          <button class="btn" onclick="refreshAll()">ðŸ”„ Refresh</button>
          <button class="btn secondary" onclick="analyzeAI()">ðŸ§  Analyze with AI</button>
          <select id="source" class="select">
            <option value="binance" selected>Binance</option>
            <option value="coingecko">CoinGecko (price only)</option>
          </select>
          <input id="apiBase" class="input" placeholder="API base (optional, e.g. https://xxxx.ngrok.io)" style="min-width:340px"/>
        </div>
        <div class="kv"><div>AI Action:</div><div id="aiAction" class="pill">â€”</div></div>
        <div class="kv"><div>TP / SL:</div><div id="aiTPSL">â€”</div></div>
        <div class="kv"><div>Confidence:</div><div id="aiConf">â€”</div></div>
        <div class="kv"><div>Reasoning:</div><div id="aiReason">â€”</div></div>
      </div>

      <div class="card">
        <h2>TFâ€‘5m Chart (Last 100 candles)</h2>
        <canvas id="chart"></canvas>
      </div>
    </div>

    <div class="card">
      <h2>Last 10 Candles (5m)</h2>
      <div id="last10" class="mono" style="overflow:auto;max-height:240px"></div>
    </div>
  </div>

  <script>
    let chart = null;
    let klines = [];
    let lastPrice = 0;

    async function fetchPrice() {
      const src = document.getElementById('source').value;
      try {
        if (src === 'binance') {
          const r = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=XRPUSDT', {cache:'no-store'});
          const j = await r.json();
          return parseFloat(j.price);
        } else {
          const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd',{cache:'no-store'});
          const j = await r.json();
          return parseFloat(j.ripple.usd);
        }
      } catch(e) {
        return lastPrice || 3.0;
      }
    }

    async function fetchKlines() {
      // 5m interval, last 100 candles
      const url = 'https://api.binance.com/api/v3/klines?symbol=XRPUSDT&interval=5m&limit=100';
      const r = await fetch(url, {cache:'no-store'});
      const j = await r.json();
      // kline format: [openTime, open, high, low, close, volume, closeTime, ...]
      return j.map(x => ({
        t: x[0], o: parseFloat(x[1]), h: parseFloat(x[2]), l: parseFloat(x[3]), c: parseFloat(x[4]), v: parseFloat(x[5])
      }));
    }

    function sma(arr, n, accessor) {
      const out=[]; let sum=0;
      for (let i=0;i<arr.length;i++){
        sum += accessor(arr[i]);
        if (i>=n) sum -= accessor(arr[i-n]);
        out.push(i>=n-1 ? sum/n : null);
      }
      return out;
    }

    function rsi14(values) {
      // classic RSI(14) on closes
      const n=14;
      if (values.length < n+1) return null;
      let gains=0, losses=0;
      for (let i=1;i<=n;i++){
        const diff = values[i]-values[i-1];
        if (diff>=0) gains += diff; else losses -= diff;
      }
      gains/=n; losses/=n;
      let rs = losses===0 ? 100 : gains/losses;
      let rsi = 100 - (100/(1+rs));
      // smoothed
      for (let i=n+1;i<values.length;i++){
        const diff = values[i]-values[i-1];
        const gain = diff>0?diff:0, loss = diff<0?-diff:0;
        gains = (gains*(n-1)+gain)/n;
        losses = (losses*(n-1)+loss)/n;
      }
      rs = losses===0 ? 100 : gains/losses;
      rsi = 100 - (100/(1+rs));
      return Math.round(rsi*10)/10;
    }

    function heuristicSignals() {
      const closes = klines.map(k=>k.c);
      const ma7 = sma(klines,7,k=>k.c);
      const ma25 = sma(klines,25,k=>k.c);
      const last = klines.length-1;
      let maSig = 'â€”';
      if (ma7[last] && ma25[last]) {
        if (ma7[last] > ma25[last]) maSig = 'Bullish';
        else if (ma7[last] < ma25[last]) maSig = 'Bearish';
        else maSig = 'Flat';
      }
      const r = rsi14(closes);
      const trend = closes[last] > closes[last-6] ? 'Up' : 'Down'; // last 30min move
      document.getElementById('maSig').textContent = maSig;
      document.getElementById('rsi').textContent = r ?? 'â€”';
      document.getElementById('trend').textContent = trend;
      return { maSig, rsi: r, trend };
    }

    function drawChart() {
      const ctx = document.getElementById('chart').getContext('2d');
      const labels = klines.map(k=> new Date(k.t).toLocaleTimeString());
      const data = klines.map(k=>k.c);
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type:'line',
        data:{labels,datasets:[{label:'Close',data,fill:false,borderWidth:2}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
      });
    }

    function showLast10() {
      const last = klines.slice(-10).map(k=> ({
        time: new Date(k.t).toISOString(),
        o:k.o, h:k.h, l:k.l, c:k.c, v:k.v
      }));
      document.getElementById('last10').textContent = JSON.stringify(last, null, 2);
    }

    async function refreshAll() {
      lastPrice = await fetchPrice();
      document.getElementById('price').textContent = '$'+ (Math.round(lastPrice*10000)/10000).toLocaleString();
      klines = await fetchKlines();
      heuristicSignals();
      drawChart();
      showLast10();
    }

    async function analyzeAI() {
      const base = (document.getElementById('apiBase').value || '').trim();
      if (!base) {
        alert('Isi API base (misal URL ngrok dari Colab) untuk pakai analisis AI.');
        return;
      }
      const payload = {
        symbol: "XRPUSDT",
        timeframe: "5m",
        last_price: lastPrice,
        klines: klines.slice(-60) // send last 60 candles
      };
      try {
        const r = await fetch(base.replace(/\/$/,'') + '/api/ai_analyze', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (!j.success) throw new Error(j.error || 'AI error');
        const out = j.data;
        document.getElementById('aiAction').textContent = out.action || 'â€”';
        document.getElementById('aiTPSL').textContent = (out.tp_pct!=null && out.sl_pct!=null) ? `${out.tp_pct}% / ${out.sl_pct}%`:'â€”';
        document.getElementById('aiConf').textContent = out.confidence!=null ? `${out.confidence}/10`:'â€”';
        document.getElementById('aiReason').textContent = out.reason || 'â€”';
      } catch(e) {
        document.getElementById('aiReason').textContent = 'Failed to call AI: ' + e.message;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      refreshAll();
      setInterval(async ()=>{
        lastPrice = await fetchPrice();
        document.getElementById('price').textContent = '$'+ (Math.round(lastPrice*10000)/10000).toLocaleString();
      }, 15000);
    });
  </script>
</body>
</html>
