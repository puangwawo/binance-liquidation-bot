
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>XRP Signals + Auto Recommendation (LIVE)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#f8fafc;color:#0f172a}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{text-align:center;margin:8px 0 14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{background:#fff;border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:16px}
    .card h2{font-size:1.05rem;margin-bottom:10px;border-bottom:3px solid #0ea5e9;display:inline-block;padding-bottom:4px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:600}
    .ok{background:#dcfce7;color:#14532d}
    .bad{background:#fee2e2;color:#7f1d1d}
    .mono{font-family:ui-monospace,Menlo,monospace;background:#f8fafc;border-radius:10px;padding:10px}
    .input,.select{padding:8px 10px;border:1px solid #e2e8f0;border-radius:10px}
    .btn{background:linear-gradient(135deg,#0ea5e9 0%,#6366f1 100%);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    .chartbox{position:relative;height:220px}
    .gauge{height:12px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .gauge>div{height:100%;background:linear-gradient(90deg,#22c55e,#ef4444);width:50%}
    .reco{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center;margin-top:6px}
    .action{font-size:1.8rem;font-weight:900}
    .BUY{color:#16a34a}.SELL{color:#ef4444}.HOLD{color:#ca8a04}
    .bar{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .bar>div{height:100%}
    .bar.buy{background:linear-gradient(90deg,#e5f9ed,#f0fdf4)} .bar.buy>div{background:#22c55e}
    .bar.sell{background:linear-gradient(90deg,#fee2e2,#fff1f2)} .bar.sell>div{background:#ef4444}
    .bar.hold{background:linear-gradient(90deg,#fef9c3,#fffbeb)} .bar.hold>div{background:#eab308}
    small.muted{color:#64748b}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üîé XRP Signals + Auto Recommendation (LIVE)</h1>

    <div class="grid">
      <div class="card">
        <h2>Live & Order Book</h2>
        <div class="row">
          <div>Price: <b id="price">$0.0000</b> <small id="priceSource" class="muted">Source: ‚Äî</small></div>
          <div>OBI: <b id="obiVal">‚Äî</b> <small id="obiSide" class="pill">‚Äî</small></div>
        </div>
        <div class="gauge" style="margin:6px 0 8px"><div id="obiGauge" style="width:50%"></div></div>
        <div class="row">
          <label>Depth <input id="depth" class="input" type="number" value="10" min="5" max="50" step="5" style="width:90px"/></label>
          <button class="btn" id="btnRefreshOB">üîÑ Refresh OB</button>
        </div>
        <div class="row" style="gap:18px;margin-top:8px">
          <div>Bids(sum): <b id="sumBids">‚Äî</b></div>
          <div>Asks(sum): <b id="sumAsks">‚Äî</b></div>
        </div>
      </div>

      <div class="card">
        <h2>Futures Funding & OI</h2>
        <div class="row" style="gap:18px">
          <div>Funding Rate: <span id="funding" class="pill">‚Äî</span></div>
          <div>Open Interest: <b id="oi">‚Äî</b> XRP</div>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <small class="muted">*Snapshot Binance Futures. Auto refresh 60s.</small>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:14px">
      <div class="card">
        <h2>TF-5m ‚Äî Close & VWAP</h2>
        <div class="chartbox"><canvas id="chart5m"></canvas></div>
        <div class="row" style="gap:16px;margin-top:8px">
          <div>VWAP: <b id="vwap">‚Äî</b></div>
          <div>Dist to VWAP: <b id="distVWAP">‚Äî</b></div>
          <div>Volume Spike (1m vs 20m avg): <span id="volSpike" class="pill">‚Äî</span></div>
        </div>
      </div>

      <div class="card">
        <h2>Signals + Auto Recommendation</h2>
        <div class="row" style="gap:10px;margin-bottom:8px">
          <button class="btn" id="btnScan">üîç Scan & Recommend</button>
          <select id="sens" class="select">
            <option value="normal" selected>Sensitivity: Normal</option>
            <option value="high">High (agresif)</option>
            <option value="low">Low (konservatif)</option>
          </select>
          <select id="mode" class="select">
            <option value="mean" selected>Mode: Mean Reversion</option>
            <option value="breakout">Mode: Breakout</option>
          </select>
          <label><input type="checkbox" id="auto" checked/> Auto scan 30s</label>
        </div>

        <div class="reco">
          <div class="action" id="recoAction">‚Äî</div>
          <div>
            <div class="bar" id="recoBar"><div style="width:0%"></div></div>
            <div style="margin-top:6px"><b id="recoStrength">0%</b> <span id="recoLabel" class="pill">‚Äî</span></div>
            <div style="margin-top:6px"><small class="muted">Weights: OBI 30%, VWAP 35%, Volume 25%, Funding/OI 10%</small></div>
          </div>
        </div>

        <div style="margin:8px 0"><b>Reasons</b></div>
        <ul id="recoReasons"><li>‚Äî</li></ul>

        <div style="margin-top:10px"><b>Raw Signals</b></div>
        <div id="signals" class="mono" style="max-height:220px;overflow:auto">[]</div>
      </div>
    </div>
  </div>

<script>
let lastPrice=3.0, priceSource='‚Äî';
let kl1=[], kl5=[], chart5=null;
let signalFeed=[];
let lastOBI={obi:50, side:'‚Äî', bids:0, asks:0};
let lastFunding={rate:0}, lastOI=0;

function addSignal(type, side, strength, details){
  signalFeed.push({ts:new Date().toISOString(), type, side, strength, details});
}
function renderSignals(){ document.getElementById('signals').textContent = JSON.stringify(signalFeed.slice(-60), null, 2); }

// Live price
async function fetchLivePrice(){
  try{
    const r = await fetch("https://api.binance.com/api/v3/ticker/price?symbol=XRPUSDT",{cache:"no-store"});
    if(!r.ok) throw new Error("binance");
    const j = await r.json();
    return { price: parseFloat(j.price), source:"Binance" };
  }catch(e){
    try{
      const r2 = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd",{cache:"no-store"});
      if(!r2.ok) throw new Error("cg");
      const j2=await r2.json();
      return { price: parseFloat(j2?.ripple?.usd), source:"CoinGecko" };
    }catch(e2){
      return { price: lastPrice||3.0, source:"Fallback" };
    }
  }
}
async function updatePriceUI(){
  const res = await fetchLivePrice();
  lastPrice=res.price; priceSource=res.source;
  document.getElementById('price').textContent = '$'+(Math.round(lastPrice*10000)/10000).toLocaleString();
  document.getElementById('priceSource').textContent = 'Source: '+priceSource;
}

// Klines
async function fetchKlines(symbol, interval, limit){
  const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
  const r = await fetch(url,{cache:'no-store'}); const j = await r.json();
  return j.map(x=>({t:x[0],o:+x[1],h:+x[2],l:+x[3],c:+x[4],v:+x[5]}));
}
function computeVWAP(kl){
  let pv=0, vol=0, vwapArr=[];
  for(const k of kl){
    const tp=(k.h+k.l+k.c)/3; pv += tp*k.v; vol += k.v;
    vwapArr.push(vol>0 ? pv/vol : null);
  }
  return vwapArr;
}
function draw5m(){
  const ctx=document.getElementById('chart5m').getContext('2d');
  const labels=kl5.map(k=>new Date(k.t).toLocaleTimeString());
  const close=kl5.map(k=>k.c);
  const vwap=computeVWAP(kl5);
  const v=vwap[vwap.length-1];
  document.getElementById('vwap').textContent = v ? v.toFixed(4) : '‚Äî';
  const dist = v ? ((lastPrice-v)/v*100) : 0;
  document.getElementById('distVWAP').textContent = v ? (dist>0?'+':'')+dist.toFixed(2)+'%' : '‚Äî';
  if(chart5) chart5.destroy();
  chart5=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Close',data:close,fill:false,borderWidth:2},{label:'VWAP',data:vwap,fill:false,borderWidth:2}]},options:{plugins:{legend:{position:'bottom'}},responsive:true,maintainAspectRatio:false}});
  return {vwapLast:v, distPct:dist};
}

// Volume spike
function volumeSpike(){
  if(kl1.length<25) return {spike:false, ratio:1, dir:'‚Äî'};
  const last=kl1[kl1.length-1]; const prev=kl1.slice(-21,-1).map(k=>k.v);
  const avg = prev.reduce((a,b)=>a+b,0)/prev.length;
  const ratio = avg>0 ? last.v/avg : 1;
  const spike = ratio>=1.5;
  const dir = last.c>last.o?'UP':'DOWN';
  const el=document.getElementById('volSpike');
  el.textContent = spike ? `Spike ${ratio.toFixed(2)}x` : '‚Äî';
  el.className = 'pill ' + (spike?'ok':'');
  return {spike, ratio, dir};
}

// Order Book Imbalance
async function refreshOrderBook(){
  const depth=Math.max(5, Math.min(50, parseInt(document.getElementById('depth').value)||10));
  const url=`https://api.binance.com/api/v3/depth?symbol=XRPUSDT&limit=${depth}`;
  try{
    const r = await fetch(url,{cache:'no-store'}); const j = await r.json();
    const sum=(arr)=>arr.reduce((a,[p,q])=>a+parseFloat(q),0);
    const bids=sum(j.bids||[]), asks=sum(j.asks||[]);
    const total=bids+asks; const obi = total>0? (bids/total*100):50;
    document.getElementById('sumBids').textContent=bids.toFixed(0);
    document.getElementById('sumAsks').textContent=asks.toFixed(0);
    document.getElementById('obiVal').textContent=obi.toFixed(1)+'% bids';
    const pill=document.getElementById('obiSide');
    pill.textContent = obi>55 ? 'BUY-Bias' : obi<45 ? 'SELL-Bias' : 'Balanced';
    pill.className='pill '+(obi>55?'ok':obi<45?'bad':'');
    document.getElementById('obiGauge').style.width=Math.max(5,Math.min(95,Math.round(obi)))+'%';
    lastOBI={obi, side: obi>=50?'UP':'DOWN', bids, asks};
    return lastOBI;
  }catch(e){
    document.getElementById('obiVal').textContent='‚Äî';
    return lastOBI;
  }
}

// Funding & OI
async function refreshFundingOI(){
  try{
    const fr=await fetch('https://fapi.binance.com/fapi/v1/fundingRate?symbol=XRPUSDT&limit=1',{cache:'no-store'});
    const jf=await fr.json(); const rate = jf && jf[0] ? parseFloat(jf[0].fundingRate) : 0;
    document.getElementById('funding').textContent=(rate*100).toFixed(4)+'%';
    document.getElementById('funding').className='pill '+(rate>0?'ok':'bad');
    lastFunding={rate};
  }catch(e){/*ignore*/}
  try{
    const oi=await fetch('https://fapi.binance.com/fapi/v1/openInterest?symbol=XRPUSDT',{cache:'no-store'});
    const jo=await oi.json(); const val = jo && jo.openInterest ? parseFloat(jo.openInterest) : 0;
    document.getElementById('oi').textContent = val.toLocaleString(undefined,{maximumFractionDigits:0});
    lastOI=val;
  }catch(e){/*ignore*/}
}

// Aggregation
function aggregateRecommendation(sens, mode){
  const vwapArr=computeVWAP(kl5); const v=vwapArr[vwapArr.length-1];
  const distPct = v ? ((lastPrice-v)/v*100) : 0;
  const wOBI=0.30, wVWAP=0.35, wVol=0.25, wFund=0.10;
  let scoreUP=0, scoreDOWN=0; const reasons=[];

  // OBI
  if(lastOBI && lastOBI.side!=='‚Äî'){
    const strength = Math.min(Math.abs(lastOBI.obi-50)/50,1);
    const s=strength*wOBI;
    if(lastOBI.side==='UP') scoreUP+=s; else scoreDOWN+=s;
    reasons.push(`OBI ${lastOBI.obi.toFixed(1)}% bids ‚Üí ${lastOBI.side==='UP'?'UP':'DOWN'} (+${Math.round(s*100)}%)`);
  }

  // VWAP: mean vs breakout
  const th = sens==='high'? 0.2 : sens==='low'? 0.4 : 0.3;
  if(v){
    let side='DOWN'; // default: price above vwap -> DOWN (mean reversion)
    if(distPct<0) side='UP';
    if(mode==='breakout'){ side = distPct>=0 ? 'UP' : 'DOWN'; } // above -> UP (continue), below -> DOWN
    const norm = Math.min(Math.abs(distPct)/th,1);
    const s=norm*wVWAP;
    if(side==='UP') scoreUP+=s; else scoreDOWN+=s;
    reasons.push(`VWAP ${distPct>0?'+':''}${distPct.toFixed(2)}% (${mode}) ‚Üí ${side} (+${Math.round(s*100)}%)`);
  }

  // Volume
  const vs=volumeSpike();
  if(vs.spike){
    let side = vs.dir;
    if(mode==='mean'){
      if(v){
        if(distPct<0 && vs.dir==='UP') side='UP';
        else if(distPct>0 && vs.dir==='DOWN') side='DOWN';
      }
    }
    const cap = sens==='high'? 2.0 : sens==='low'? 3.0 : 2.5;
    const strength = Math.min((vs.ratio-1)/(cap-1),1);
    const s=strength*wVol;
    if(side==='UP') scoreUP+=s; else if(side==='DOWN') scoreDOWN+=s;
    reasons.push(`Volume spike ${vs.ratio.toFixed(2)}x (dir ${side}) (+${Math.round(s*100)}%)`);
  }

  // Funding
  if(typeof lastFunding.rate==='number'){
    const ratePct=lastFunding.rate*100;
    const norm = Math.min(Math.abs(ratePct)/(sens==='high'?0.02: sens==='low'?0.06:0.04),1);
    const s=norm*wFund;
    const side = ratePct>=0 ? 'UP' : 'DOWN';
    if(side==='UP') scoreUP+=s; else scoreDOWN+=s;
    reasons.push(`Funding ${ratePct.toFixed(4)}% ‚Üí ${side} (+${Math.round(s*100)}%)`);
  }

  const totalWeight=wOBI+wVWAP+wVol+wFund;
  const maxScore = Math.max(scoreUP, scoreDOWN);
  const pct = Math.round((maxScore/totalWeight)*100);
  let action='HOLD'; if(pct>=40){ action = scoreUP>scoreDOWN ? 'BUY' : 'SELL'; }
  let label='Weak'; if(pct>=70) label='Strong'; else if(pct>=40) label='Medium';
  return {action,pct,label,reasons};
}

// Scan workflow
async function scanAndRender(){
  await updatePriceUI();
  kl1 = await fetchKlines('XRPUSDT','1m',120);
  kl5 = await fetchKlines('XRPUSDT','5m',120);
  draw5m();
  await refreshOrderBook();
  await refreshFundingOI();
  const sens=document.getElementById('sens').value;
  const mode=document.getElementById('mode').value;

  // Rebuild raw signals for transparency
  signalFeed=[];
  if(lastOBI.obi>=65) addSignal('OrderBookImbalance','UP','strong',`OBI=${lastOBI.obi.toFixed(1)}% bids`);
  else if(lastOBI.obi<=35) addSignal('OrderBookImbalance','DOWN','strong',`OBI=${(100-lastOBI.obi).toFixed(1)}% asks`);
  const vs=volumeSpike();
  if(vs.spike) addSignal('VolumeSpike', vs.dir, vs.ratio>2?'strong':'medium', `${vs.ratio.toFixed(2)}x avg`);
  const vwap=computeVWAP(kl5); const v=vwap[vwap.length-1];
  if(v){
    const dist=(lastPrice-v)/v*100;
    const th = sens==='high'?0.15: sens==='low'?0.35:0.25;
    if(Math.abs(dist)>=th) addSignal('VWAP-Distance', dist>0?'UP':'DOWN', Math.abs(dist)>=th*2?'strong':'medium', `${dist>0?'+':''}${dist.toFixed(2)}%`);
  }
  renderSignals();

  const reco = aggregateRecommendation(sens, mode);
  // UI
  const actEl=document.getElementById('recoAction');
  actEl.textContent=reco.action; actEl.className='action '+reco.action;
  const bar=document.getElementById('recoBar'); bar.className='bar '+(reco.action==='BUY'?'buy':reco.action==='SELL'?'sell':'hold');
  bar.firstElementChild.style.width=reco.pct+'%';
  document.getElementById('recoStrength').textContent=reco.pct+'%';
  const lab=document.getElementById('recoLabel'); lab.textContent=reco.label; lab.className='pill '+(reco.label==='Strong'?(reco.action==='BUY'?'ok':'bad'):'');
  const ul=document.getElementById('recoReasons'); ul.innerHTML=''; reco.reasons.forEach(r=>{ const li=document.createElement('li'); li.textContent=r; ul.appendChild(li); });
}

// Boot
document.addEventListener('DOMContentLoaded', async ()=>{
  await scanAndRender();
  document.getElementById('btnScan').onclick=scanAndRender;
  document.getElementById('btnRefreshOB').onclick=refreshOrderBook;
  // Auto loops
  setInterval(updatePriceUI, 15000);
  setInterval(refreshOrderBook, 15000);
  setInterval(refreshFundingOI, 60000);
  setInterval(async ()=>{ if(document.getElementById('auto').checked){ await scanAndRender(); } }, 30000);
});
</script>
</body>
</html>
